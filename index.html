<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#667eea">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="manifest" href="manifest.json">
        <link rel="apple-touch-icon" href="icons/icon-192x192.png">
        <title>G√©oWeb Kaffrine</title>
        
        <!-- Styles externes -->
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/app-modern.css?v=18">
        <link rel="stylesheet" href="css/fab-simple.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/tutorial.css">
        <link rel="stylesheet" href="css/metadata.css">
        <link rel="stylesheet" href="css/app-modern.css?v=18">
        <link rel="stylesheet" href="css/dark-theme.css">
        <link rel="stylesheet" href="css/mobile-responsive.css">
        <link rel="stylesheet" href="css/fullscreen-responsive.css">
    </head>
    <body>
        <!-- Skip to content pour accessibilit√© -->
        <a href="#main-content" class="skip-link">Aller au contenu principal</a>
        
        <!-- Barre de navigation s√©mantique -->
        <header role="banner">
        <nav class="navbar" role="navigation" aria-label="Navigation principale">
            <div class="navbar-brand" onclick="location.reload()" style="cursor: pointer;" title="Cliquez pour recharger la page" role="button" tabindex="0" aria-label="Recharger G√©oWeb Kaffrine">
                <div class="logo-container">
                    <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="50" cy="50" r="45" fill="#667eea"/>
                        <circle cx="50" cy="50" r="35" fill="#764ba2"/>
                        <path d="M50 20 L55 45 L80 50 L55 55 L50 80 L45 55 L20 50 L45 45 Z" fill="white"/>
                        <circle cx="50" cy="50" r="8" fill="#333"/>
                    </svg>
                </div>
                <h1 class="brand-text">G√©oWeb Kaffrine</h1>
            </div>
            <ul class="navbar-menu" role="menubar" aria-label="Menu principal">
                <!-- Navigation -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" role="menuitem" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-compass"></i>
                        <span>Navigation</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h6 class="dropdown-title">Navigation principale</h6>
                            <div class="dropdown-items">
                                <a href="#" onclick="showHome()" role="menuitem">
                                    <i class="fas fa-home"></i>
                                    <span>Accueil</span>
                                </a>
                                <a href="#" onclick="showAbout()" role="menuitem">
                                    <i class="fas fa-info-circle"></i>
                                    <span>√Ä propos</span>
                                </a>
                                <a href="#" onclick="showMetadata()" role="menuitem">
                                    <i class="fas fa-info"></i>
                                    <span>M√©tadonn√©es</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </li>
                
                <!-- Donn√©es -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" role="menuitem" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-database"></i>
                        <span>Donn√©es</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h6 class="dropdown-title">Couches et fonds</h6>
                            <div class="dropdown-items">
                                <a href="#" onclick="toggleLeftPanel()" role="menuitem">
                                    <i class="fas fa-layer-group"></i>
                                    <span>Couches</span>
                                </a>
                                <a href="#" onclick="toggleRightPanel()" role="menuitem">
                                    <i class="fas fa-palette"></i>
                                    <span>Fonds & L√©gende</span>
                                </a>
                            </div>
                        </div>
                        <div class="dropdown-section">
                            <h6 class="dropdown-title">Export</h6>
                            <div class="dropdown-items">
                                <a href="#" onclick="downloadData('geojson')" role="menuitem">
                                    <i class="fas fa-file-code"></i>
                                    <span>GeoJSON</span>
                                </a>
                                <a href="#" onclick="downloadData('shapefile')" role="menuitem">
                                    <i class="fas fa-file-archive"></i>
                                    <span>Shapefile</span>
                                </a>
                                <a href="#" onclick="downloadData('kml')" role="menuitem">
                                    <i class="fas fa-file-alt"></i>
                                    <span>KML</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </li>
                
                <!-- Analyse -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" role="menuitem" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-chart-line"></i>
                        <span>Analyse</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h6 class="dropdown-title">Outils d'analyse</h6>
                            <div class="dropdown-items">
                                <a href="#" onclick="showAttributeQuery()" role="menuitem">
                                    <i class="fas fa-search"></i>
                                    <span>Rechercher</span>
                                </a>
                                <a href="#" onclick="showSpatialQuery()" role="menuitem">
                                    <i class="fas fa-map"></i>
                                    <span>Analyser</span>
                                </a>
                                <a href="#" onclick="enableRoutingMode()" role="menuitem">
                                    <i class="fas fa-road"></i>
                                    <span>Itin√©raire</span>
                                </a>
                                <a href="#" onclick="clearRouting()" role="menuitem" style="margin-left: 10px; font-size: 0.85rem; color: #999;">
                                    <i class="fas fa-trash"></i> R√©initialiser
                                </a>
                                <a href="#" onclick="toggleMeasure()" role="menuitem">
                                    <i class="fas fa-ruler-combined"></i>
                                    <span>Mesurer</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </li>
                
                <!-- Affichage -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" role="menuitem" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-eye"></i>
                        <span>Affichage</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h6 class="dropdown-title">Contr√¥les de vue</h6>
                            <div class="dropdown-items">
                                <a href="#" onclick="map.zoomIn()" role="menuitem">
                                    <i class="fas fa-search-plus"></i>
                                    <span>Zoom Avant</span>
                                </a>
                                <a href="#" onclick="map.zoomOut()" role="menuitem">
                                    <i class="fas fa-search-minus"></i>
                                    <span>Zoom Arri√®re</span>
                                </a>
                                <a href="#" onclick="resetZoom()" role="menuitem">
                                    <i class="fas fa-expand"></i>
                                    <span>Vue compl√®te</span>
                                </a>
                                <a href="#" onclick="toggleTheme()" role="menuitem">
                                    <i class="fas fa-adjust"></i>
                                    <span>Th√®me clair/sombre</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
            <div class="navbar-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()" title="Changer de th√®me">
                <i class="fas fa-moon" id="themeIcon"></i>
            </div>
            <div class="install-toggle" onclick="showInstallModal()" title="Installer l'application">
                <i class="fas fa-mobile-alt"></i>
            </div>
        </nav>

        <!-- Modal de Bienvenue avec Tutoriel -->
        <div id="welcomeModal" class="modal welcome-modal">
            <div class="modal-content welcome-content">
                <div class="welcome-header">
                    <svg class="welcome-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="#667eea"/>
                        <circle cx="50" cy="50" r="35" fill="#764ba2"/>
                        <path d="M50 20 L55 45 L80 50 L55 55 L50 80 L45 55 L20 50 L45 45 Z" fill="white"/>
                        <circle cx="50" cy="50" r="8" fill="#333"/>
                    </svg>
                    <h2>Bienvenue sur G√©oWeb Kaffrine</h2>
                    <p class="welcome-subtitle">Plateforme interactive de visualisation et d'analyse g√©ographique de la r√©gion de Kaffrine</p>
                </div>
                
                <div class="tutorial-section">
                    <h3><i class="fas fa-graduation-cap"></i> Tutoriel Rapide</h3>
                    
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4><i class="fas fa-map"></i> Explorer la carte</h4>
                                <p>Activez les couches th√©matiques pour visualiser les donn√©es disponibles (administratives, infrastructures, localit√©s).</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4><i class="fas fa-search"></i> Rechercher des informations</h4>
                                <p>Utilisez la fonction de recherche pour trouver un √©tablissement scolaire ou une localit√© sp√©cifique.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4><i class="fas fa-chart-line"></i> Analyser</h4>
                                <p>Utilisez les outils d'analyse spatiale et de mesure pour √©tudier les zones et calculer des distances.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4><i class="fas fa-road"></i> Calculer un itin√©raire</h4>
                                <p>S√©lectionnez un point de d√©part et un point d'arriv√©e pour obtenir un trajet avec distance et temps.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-footer">
                    <button class="btn btn-primary" onclick="closeWelcomeModal()">
                        <i class="fas fa-map-marked-alt"></i> Commencer l'exploration
                    </button>
                    <button class="btn btn-secondary" onclick="showMetadata()" style="margin-left: 10px;">
                        <i class="fas fa-info-circle"></i> Voir les m√©tadonn√©es
                    </button>
                    <label class="dont-show-again">
                        <input type="checkbox" id="dontShowWelcome"> Ne plus afficher au prochain chargement
                    </label>
                </div>
                <button class="modal-close" onclick="closeWelcomeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Container principal -->
        <div class="app-container">
            <!-- Panneau de gauche - Controle des couches -->
            <div class="sidebar-left collapsed" id="sidebarLeft">
                <div class="panel-header">
                    <h3><i class="fas fa-layer-group"></i> Couches</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="panel-toggle" onclick="toggleLeftPanel()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="panel-close-mobile" onclick="closeLeftPanel()" style="display: none; background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content" id="layerControlContainer">
                    <!-- Le controle des couches sera injecte ici -->
                </div>
            </div>

            <!-- Zone de la carte -->
            <div class="map-container">
                <div id="map" style="width: 100%; height: 100%; min-height: 400px;"></div>
                
                <!-- Barre de statut en bas -->
                <div class="status-bar">
                    <div class="status-left">
                        <span id="coordinates"><i class="fas fa-map-marker-alt"></i> Coordonnees: --</span>
                    </div>
                    <div class="status-center">
                        <span id="scale"><i class="fas fa-ruler"></i> Echelle: --</span>
                    </div>
                    <div class="status-right">
                        <span id="zoom-level"><i class="fas fa-search"></i> Zoom: --</span>
                    </div>
                </div>
            </div>

            <!-- Panneau de droite - Legende et fonds de carte -->
            <div class="sidebar-right collapsed" id="sidebarRight">
                <div class="panel-header">
                    <div style="display: flex; gap: 10px;">
                        <button class="panel-close-mobile" onclick="closeRightPanel()" style="display: none; background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="panel-toggle" onclick="toggleRightPanel()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <h3>Fonds de carte & Legende</h3>
                </div>
                <div class="panel-content">
                    <div class="basemaps-section">
                        <h4><i class="fas fa-globe"></i> Fonds de carte</h4>
                        <div id="basemapControl">
                            <div class="basemap-option active" onclick="changeBasemap('OSMStandard')">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' fill='white' font-size='12'%3EOSM%3C/text%3E%3C/svg%3E" alt="OSM">
                                <span>OpenStreetMap</span>
                            </div>
                            <div class="basemap-option" onclick="changeBasemap('GoogleHybrid')">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23228b22' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' fill='white' font-size='12'%3EGoogle%3C/text%3E%3C/svg%3E" alt="Google">
                                <span>Google Hybrid</span>
                            </div>
                            <div class="basemap-option" onclick="changeBasemap('CartoDbDarkMatter')">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23222' width='100' height='100'/%3E%3Ctext x='50' y='50' text-anchor='middle' fill='white' font-size='12'%3EDark%3C/text%3E%3C/svg%3E" alt="Dark">
                                <span>CartoDB Dark</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="legend-section">
                        <h4><i class="fas fa-palette"></i> Legende</h4>
                        <div id="legendControl">
                            <!-- R√©gion -->
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: transparent; border: 3px solid rgba(35,35,35,1.0);"></div>
                                <span>R√©gion Kaffrine</span>
                            </div>
                            
                            <!-- D√©partements -->
                            <div class="legend-subtitle">
                                <strong><i class="fas fa-layer-group"></i> D√©partements</strong>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(126,222,43,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>BIRKELANE</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(214,97,39,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>KAFFRINE</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(211,108,199,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>KOUNGHEUL</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(101,202,175,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>MALEM HODDAR</span>
                            </div>
                            
                            <!-- Arrondissements -->
                            <div class="legend-subtitle">
                                <strong><i class="fas fa-layer-group"></i> Arrondissements</strong>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(212,225,126,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>DAROU MINAME II</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(168,29,214,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>GNIBY</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(132,116,220,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>IDA MOURIDE</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(200,69,76,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>KATAKEL</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(202,130,41,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>KEUR MBOUCKI</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(61,142,235,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>LOUR ESCALE</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(234,59,173,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>MABO</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(68,214,204,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>MISSIRAH WADENE</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: rgba(87,201,45,1.0); border: 2px solid rgba(35,35,35,1.0);"></div>
                                <span>SAGNA</span>
                            </div>
                            
                            <!-- Infrastructure -->
                            <div class="legend-subtitle">
                                <strong><i class="fas fa-road"></i> Infrastructure</strong>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: rgba(255,0,0,1.0); height: 3px;"></div>
                                <span>Routes</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-point" style="background: rgba(83,83,83,1.0); border: 2px solid rgba(247,247,247,1.0); width: 8px; height: 8px; border-radius: 50%;"></div>
                                <span>Localit√©s</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-point" style="background: rgba(184,8,8,1.0); width: 10px; height: 10px; border-radius: 50%;"></div>
                                <span>√âcoles</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons flottants -->
        <div class="floating-controls">
            <button class="float-btn" onclick="locateUser()" title="Localiser ma position">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="float-btn" onclick="resetZoom()" title="Vue complete">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button class="float-btn" onclick="toggleMeasure()" title="Outil de mesure">
                <i class="fas fa-ruler"></i>
            </button>
        </div>

        <!-- Boutons pour panneaux mobile -->
        <div class="mobile-panel-buttons">
            <button class="mobile-panel-btn" onclick="toggleLeftPanel()" title="Couches">
                <i class="fas fa-th"></i>
            </button>
            <button class="mobile-panel-btn" onclick="toggleRightPanel()" title="L√©gende">
                <i class="fas fa-palette"></i>
            </button>
            <button class="mobile-panel-btn" onclick="showInstallModal()" title="Installer">
                <i class="fas fa-download"></i>
            </button>
        </div>

        <!-- Modal Mini Tutoriel -->
        <div id="miniTutorialModal" class="modal mini-tutorial-modal">
            <div class="modal-content mini-tutorial-content">
                <button class="modal-close tutorial-close" onclick="closeMiniTutorial()">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="tutorial-header">
                    <h2><i class="fas fa-graduation-cap"></i> Tutoriel Rapide</h2>
                    <div class="tutorial-progress">
                        <span id="tutorialStep">1</span> / <span id="tutorialTotal">4</span>
                    </div>
                </div>
                
                <div class="tutorial-body">
                    <!-- √âtape 1 -->
                    <div class="tutorial-step active" id="tutorialStep1">
                        <div class="step-icon">
                            <i class="fas fa-map"></i>
                        </div>
                        <h3>Explorer la carte</h3>
                        <p>Activez les couches th√©matiques pour visualiser les donn√©es administratives, infrastructures et localit√©s de la r√©gion de Kaffrine.</p>
                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="toggleLeftPanel()">
                                <i class="fas fa-layer-group"></i> Voir les couches
                            </button>
                        </div>
                    </div>
                    
                    <!-- √âtape 2 -->
                    <div class="tutorial-step" id="tutorialStep2">
                        <div class="step-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Rechercher</h3>
                        <p>Trouvez rapidement une √©cole, une localit√© ou n'importe quel point d'int√©r√™t dans la r√©gion.</p>
                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="showAttributeQuery(); closeMiniTutorial();">
                                <i class="fas fa-search"></i> Lancer une recherche
                            </button>
                        </div>
                    </div>
                    
                    <!-- √âtape 3 -->
                    <div class="tutorial-step" id="tutorialStep3">
                        <div class="step-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Analyser</h3>
                        <p>Effectuez des analyses spatiales autour d'un point pour trouver les √©coles, localit√©s ou infrastructures √† proximit√©.</p>
                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="showSpatialQuery(); closeMiniTutorial();">
                                <i class="fas fa-map"></i> Lancer une analyse
                            </button>
                        </div>
                    </div>
                    
                    <!-- √âtape 4 -->
                    <div class="tutorial-step" id="tutorialStep4">
                        <div class="step-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <h3>Itin√©raire</h3>
                        <p>S√©lectionnez un point de d√©part et un point d'arriv√©e pour obtenir le meilleur trajet avec distance et temps.</p>
                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="enableRoutingMode(); closeMiniTutorial();">
                                <i class="fas fa-road"></i> Calculer un itin√©raire
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tutorial-footer">
                    <div class="tutorial-nav">
                        <button class="btn btn-secondary" id="tutorialPrev" onclick="previousTutorialStep()" disabled>
                            <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                        </button>
                        <button class="btn btn-primary" id="tutorialNext" onclick="nextTutorialStep()">
                            Suivant <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="tutorial-options">
                        <label class="dont-show-tutorial">
                            <input type="checkbox" id="dontShowMiniTutorial">
                            <span>Ne plus afficher ce tutoriel</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="aboutModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('aboutModal')">&times;</span>
                <h2><i class="fas fa-info-circle"></i> A propos</h2>
                <p>Cette application Web GIS presente les donnees geographiques de la region de Kaffrine au Senegal.</p>
                <p><strong>Donnees disponibles:</strong></p>
                <ul>
                    <li><i class="fas fa-th"></i> Limites administratives (Regions, Departements, Arrondissements)</li>
                    <li><i class="fas fa-road"></i> Reseau routier</li>
                    <li><i class="fas fa-map-marker-alt"></i> Localites</li>
                    <li><i class="fas fa-school"></i> Ecoles</li>
                </ul>
                <p><strong>Technologies:</strong> Leaflet.js, QGIS2WEB, OpenStreetMap</p>
                <p><strong>D√©veloppeur:</strong></p>
                <p>
                    <strong>Mouhsine Abdallah Babacar DIAO</strong><br>
                    üì±: 778379457<br>
                    üìß: mouhsineabdallahbabacar@gmail.com<br>
                    üìß: diao.mouhsine@uam.edu.sn
                </p>
            </div>
        </div>

        <!-- Modal d'installation PWA -->
        <div id="installModal" class="modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <span class="modal-close" onclick="closeModal('installModal')">&times;</span>
                <div style="padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üì±</div>
                    <h2 style="margin-bottom: 20px; color: #333;">Installer G√©oWeb Kaffrine</h2>
                    <p style="margin-bottom: 25px; color: #666; line-height: 1.6;">
                        Installez cette application sur votre t√©l√©phone pour un acc√®s rapide et hors ligne.
                    </p>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left;">
                        <h3 style="font-size: 1rem; margin-bottom: 15px; color: #333;">
                            <i class="fas fa-info-circle" style="color: #667eea;"></i> Comment installer :
                        </h3>
                        <div id="installInstructions">
                            <p><strong>Android (Chrome) :</strong></p>
                            <ol style="margin-left: 20px; line-height: 1.8;">
                                <li>Cliquez sur ‚ãÆ en haut √† droite</li>
                                <li>S√©lectionnez "Ajouter √† l'√©cran d'accueil"</li>
                            </ol>
                            <p style="margin-top: 10px;"><strong>iOS (Safari) :</strong></p>
                            <ol style="margin-left: 20px; line-height: 1.8;">
                                <li>Cliquez sur ‚éò en bas</li>
                                <li>S√©lectionnez "Sur l'√©cran d'accueil"</li>
                            </ol>
                        </div>
                    </div>
                    <button onclick="closeModal('installModal')" class="btn-primary" style="width: 100%;">
                        <i class="fas fa-check"></i> J'ai compris
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Analyse Spatiale AM√âLIOR√â -->
        <div id="spatialQueryModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="modal-close" onclick="closeModal('spatialQueryModal')">&times;</span>
                <h2><i class="fas fa-map"></i> Analyser autour d'un point</h2>
                <div style="padding: 20px;">
                    
                    <!-- √âtape 1: Choisir la couche cible -->
                    <div id="spatialStep1" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">1. Que cherchez-vous ?</label>
                        <select id="spatialTargetLayer" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Ecoles">√âcoles</option>
                            <option value="Localites">Localit√©s</option>
                            <option value="Routes">Routes</option>
                            <option value="Arrondissement">Arrondissements</option>
                        </select>
                    </div>
                    
                    <!-- √âtape 2: Type de requ√™te -->
                    <div id="spatialStep2" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">2. Type de requ√™te:</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="setSpatialQueryType('buffer')" class="btn-spatial-type" id="btnTypeBuffer" style="padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; text-align: left;">
                                <i class="fas fa-circle-notch"></i> <b>Buffer (zone tampon)</b><br>
                                <small style="opacity: 0.9;">Trouver tout dans un rayon de X m√®tres</small>
                            </button>
                            <button onclick="setSpatialQueryType('nearest')" class="btn-spatial-type" id="btnTypeNearest" style="padding: 12px; border: 2px solid #e0e0e0; background: white; color: #333; border-radius: 8px; cursor: pointer; text-align: left;">
                                <i class="fas fa-bullseye"></i> <b>Les plus proches</b><br>
                                <small>Trouver les X √©l√©ments les plus proches</small>
                            </button>
                            <button onclick="setSpatialQueryType('click')" class="btn-spatial-type" id="btnTypeClick" style="padding: 12px; border: 2px solid #e0e0e0; background: white; color: #333; border-radius: 8px; cursor: pointer; text-align: left;">
                                <i class="fas fa-hand-pointer"></i> <b>Cliquer sur la carte</b><br>
                                <small>Cliquez pour voir ce qui est proche</small>
                            </button>
                        </div>
                    </div>
                    
                    <!-- √âtape 3: Param√®tres du buffer -->
                    <div id="spatialBufferParams" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">3. Distance du buffer:</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                            <button onclick="setBufferDistance(5)" class="btn-buffer" data-dist="5" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">5m</button>
                            <button onclick="setBufferDistance(10)" class="btn-buffer" data-dist="10" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">10m</button>
                            <button onclick="setBufferDistance(50)" class="btn-buffer" data-dist="50" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">50m</button>
                            <button onclick="setBufferDistance(100)" class="btn-buffer" data-dist="100" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">100m</button>
                            <button onclick="setBufferDistance(500)" class="btn-buffer" data-dist="500" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">500m</button>
                            <button onclick="setBufferDistance(1000)" class="btn-buffer" data-dist="1000" style="padding: 10px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">1km</button>
                            <button onclick="setBufferDistance(2000)" class="btn-buffer" data-dist="2000" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">2km</button>
                            <button onclick="setBufferDistance(5000)" class="btn-buffer" data-dist="5000" style="padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-weight: 600;">5km</button>
                        </div>
                        <input type="hidden" id="bufferDistanceValue" value="1000">
                    </div>
                    
                    <!-- √âtape 3 bis: Param√®tres nearest -->
                    <div id="spatialNearestParams" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">3. Nombre d'√©l√©ments:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="range" id="nearestCount" min="1" max="20" value="5" style="flex: 1;" oninput="document.getElementById('nearestCountDisplay').textContent = this.value">
                            <span id="nearestCountDisplay" style="font-weight: 600; min-width: 30px; text-align: center;">5</span>
                        </div>
                    </div>
                    
                    <!-- Bouton ex√©cuter -->
                    <div id="spatialExecute" style="margin-bottom: 20px;">
                        <button onclick="executeAdvancedSpatialQuery()" class="btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                            <i class="fas fa-play"></i> LANCER LA RECHERCHE
                        </button>
                    </div>
                    
                    <!-- Instructions pour clic -->
                    <div id="spatialClickInstructions" style="display: none; padding: 15px; background: #f0f4ff; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 0; color: #667eea;"><i class="fas fa-info-circle"></i> Cliquez sur la carte pour d√©finir le point de recherche</p>
                    </div>
                    
                    <!-- R√©sultats -->
                    <div id="spatialAdvancedResults" style="display: none;">
                        <div id="spatialAdvancedResultsContent" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px;"></div>
                        <button onclick="clearAdvancedSpatialQuery()" class="btn-secondary" style="width: 100%; padding: 10px;">
                            <i class="fas fa-trash"></i> Nouvelle recherche
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal M√©tadonn√©es -->
        <div id="metadataModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('metadataModal')">&times;</span>
                <h2><i class="fas fa-info"></i> M√©tadonn√©es des Donn√©es</h2>
                
                <div class="metadata-tabs">
                    <button class="metadata-tab active" onclick="showMetadataTab('general')">
                        <i class="fas fa-globe"></i> G√©n√©ral
                    </button>
                    <button class="metadata-tab" onclick="showMetadataTab('layers')">
                        <i class="fas fa-layer-group"></i> Couches
                    </button>
                    <button class="metadata-tab" onclick="showMetadataTab('technical')">
                        <i class="fas fa-cog"></i> Technique
                    </button>
                </div>
                
                <div id="metadataGeneral" class="metadata-content">
                    <div class="metadata-section">
                        <h3><i class="fas fa-database"></i> Source des donn√©es</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">Organisme</div>
                                <div class="metadata-item-value">Direction R√©gionale de la Statistique et de la D√©mographie (DRSD) Kaffrine</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Partenaire technique</div>
                                <div class="metadata-item-value">UAM - Universit√© Amadou Mahtar Mbow</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Projet</div>
                                <div class="metadata-item-value">Plateforme G√©oWeb Kaffrine</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Responsable</div>
                                <div class="metadata-item-value">Mouhsine Abdallah Babacar DIAO</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <h3><i class="fas fa-calendar"></i> P√©riode de r√©f√©rence</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">Derni√®re mise √† jour</div>
                                <div class="metadata-item-value">D√©cembre 2024</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Recensement</div>
                                <div class="metadata-item-value">RGPH 2013</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Mise √† jour infrastructures</div>
                                <div class="metadata-item-value">2024</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Fr√©quence de mise √† jour</div>
                                <div class="metadata-item-value">Annuelle</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <h3><i class="fas fa-map"></i> Zone g√©ographique</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">R√©gion</div>
                                <div class="metadata-item-value">Kaffrine</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Superficie</div>
                                <div class="metadata-item-value">11,242 km¬≤</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Population</div>
                                <div class="metadata-item-value">668,474 habitants (RGPH 2013)</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">D√©partements</div>
                                <div class="metadata-item-value">4 (Birkelane, Kaffrine, Koungheul, Malem Hoddar)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="metadataLayers" class="metadata-content" style="display: none;">
                    <div class="metadata-section">
                        <h3><i class="fas fa-layer-group"></i> Couches administratives</h3>
                        <div class="layer-metadata">
                            <div class="layer-item">
                                <h4><i class="fas fa-map"></i> Limites administratives</h4>
                                <ul>
                                    <li><strong>R√©gion Kaffrine:</strong> 1 entit√©</li>
                                    <li><strong>D√©partements:</strong> 4 d√©partements</li>
                                    <li><strong>Arrondissements:</strong> 11 arrondissements</li>
                                    <li><strong>Pr√©cision:</strong> Niveau administratif officiel</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <h3><i class="fas fa-road"></i> Couches d'infrastructures</h3>
                        <div class="layer-metadata">
                            <div class="layer-item">
                                <h4><i class="fas fa-road"></i> R√©seau routier</h4>
                                <ul>
                                    <li><strong>Type:</strong> Routes principales et secondaires</li>
                                    <li><strong>Source:</strong> Donn√©es administratives</li>
                                    <li><strong>Mise √† jour:</strong> 2024</li>
                                </ul>
                            </div>
                            
                            <div class="layer-item">
                                <h4><i class="fas fa-map-marker-alt"></i> Localit√©s</h4>
                                <ul>
                                    <li><strong>Type:</strong> Villages et villes</li>
                                    <li><strong>Nombre:</strong> +500 localit√©s</li>
                                    <li><strong>Attributs:</strong> Nom, type, population</li>
                                </ul>
                            </div>
                            
                            <div class="layer-item">
                                <h4><i class="fas fa-school"></i> √âtablissements scolaires</h4>
                                <ul>
                                    <li><strong>Type:</strong> √âcoles primaires et secondaires</li>
                                    <li><strong>Couverture:</strong> Ensemble de la r√©gion</li>
                                    <li><strong>Attributs:</strong> Nom, type, coordonn√©es</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="metadataTechnical" class="metadata-content" style="display: none;">
                    <div class="metadata-section">
                        <h3><i class="fas fa-globe"></i> Syst√®me de r√©f√©rence</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">Syst√®me de projection</div>
                                <div class="metadata-item-value">WGS84 (EPSG:4326)</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Format des donn√©es</div>
                                <div class="metadata-item-value">GeoJSON</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Pr√©cision</div>
                                <div class="metadata-item-value">Niveau administratif</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">√âchelle de r√©f√©rence</div>
                                <div class="metadata-item-value">1:50 000</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <h3><i class="fas fa-shield-alt"></i> Conditions d'utilisation</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">Usage autoris√©</div>
                                <div class="metadata-item-value">Consultation et analyse <span class="metadata-badge">Public</span></div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Restrictions</div>
                                <div class="metadata-item-value">Usage commercial non autoris√© sans accord</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Citation requise</div>
                                <div class="metadata-item-value">DRSD Kaffrine / UAM - Ann√©e 2024</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Licence</div>
                                <div class="metadata-item-value">Ouverte avec conditions</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metadata-section">
                        <h3><i class="fas fa-user"></i> Contact technique</h3>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <div class="metadata-item-label">Coordonnateur</div>
                                <div class="metadata-item-value">Mouhsine Abdallah Babacar DIAO</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Email institutionnel</div>
                                <div class="metadata-item-value">diao.mouhsine@uam.edu.sn</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">Email personnel</div>
                                <div class="metadata-item-value">mouhsineabdallahbabacar@gmail.com</div>
                            </div>
                            <div class="metadata-item">
                                <div class="metadata-item-label">T√©l√©phone</div>
                                <div class="metadata-item-value">+221 77 837 94 57</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Recherche d'Informations AM√âLIOR√â -->
        <div id="attributeQueryModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('attributeQueryModal')">&times;</span>
                <h2><i class="fas fa-database"></i> Rechercher des informations</h2>
                <div style="padding: 20px;">
                    <!-- √âtape 1: Choisir la couche -->
                    <div id="attrStep1" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">1. Choisir la couche:</label>
                        <select id="attrLayerSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" onchange="updateAttrFields()">
                            <option value="">-- S√©lectionner une couche --</option>
                            <option value="Ecoles">√âcoles</option>
                            <option value="Localites">Localit√©s</option>
                            <option value="Departement">D√©partements</option>
                            <option value="Arrondissement">Arrondissements</option>
                            <option value="Region">R√©gions</option>
                            <option value="Routes">Routes</option>
                        </select>
                    </div>
                    
                    <!-- √âtape 2: Choisir le champ -->
                    <div id="attrStep2" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">2. Choisir le champ:</label>
                        <select id="attrFieldSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">-- S√©lectionner un champ --</option>
                            <option value="Nom">Nom</option>
                            <option value="code">Code</option>
                            <option value="dept">D√©partement</option>
                            <option value="arr">Arrondissement</option>
                            <option value="type">Type</option>
                            <option value="*">Tous les champs</option>
                        </select>
                    </div>
                    
                    <!-- √âtape 3: Type de recherche -->
                    <div id="attrStep3" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">3. Type de recherche:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="setAttrOperator('equals')" class="btn-operator" id="btnOpEquals" style="flex: 1; padding: 8px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer;">= √âgal</button>
                            <button onclick="setAttrOperator('contains')" class="btn-operator" id="btnOpContains" style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; background: white; color: #333; border-radius: 6px; cursor: pointer;">Contient</button>
                            <button onclick="setAttrOperator('starts')" class="btn-operator" id="btnOpStarts" style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; background: white; color: #333; border-radius: 6px; cursor: pointer;">Commence par</button>
                        </div>
                    </div>
                    
                    <!-- √âtape 4: Valeur √† chercher -->
                    <div id="attrStep4" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #667eea;">4. Valeur √† chercher:</label>
                        <input type="text" id="attrSearchValue" placeholder="Tapez la valeur..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 10px;">
                        <button onclick="executeAdvancedAttrQuery()" class="btn-primary" style="width: 100%; padding: 12px; font-size: 1rem;">
                            <i class="fas fa-search"></i> LANCER LA RECHERCHE
                        </button>
                    </div>
                    
                    <!-- R√©sultats -->
                    <div id="attrResults" style="display: none; margin-top: 15px;">
                        <div id="attrResultsContent" style="max-height: 300px; overflow-y: auto;"></div>
                        <button onclick="clearAttrQuery()" class="btn-secondary" style="width: 100%; margin-top: 10px; padding: 10px;">
                            <i class="fas fa-trash"></i> Nouvelle recherche
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts de compatibilit√© -->
        <!-- Supprim√©s : leaflet-routing-machine.js, leaflet-hash-compat.js -->
        
        <!-- Scripts -->
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/multi-style-layer.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <!-- <script src="js/leaflet.pattern.js"></script> --> <!-- D√©sactiv√© √† cause des erreurs L.Mixin.Events -->
        <script src="js/leaflet.markercluster.js"></script>
        <!-- <script src="js/leaflet-search.js"></script> --> <!-- D√©sactiv√© √† cause des erreurs L.Mixin.Events -->
        <script src="js/leaflet-measure.js"></script>
        <!-- <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script> --> <!-- D√©sactiv√© √† cause des erreurs Tracking Prevention -->
        <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/> --> <!-- D√©sactiv√© √† cause des erreurs Tracking Prevention -->
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        
        <!-- Modules d'application -->
        <script src="js/map-core-module.js"></script>
        <script src="js/guide-module.js"></script>
        <script src="js/metadata-module.js"></script>
        <script src="js/spatial-analysis-module.js"></script>
        <script src="js/analysis-improved.js"></script>
        <!-- <script src="js/routing-module.js"></script> --> <!-- D√©sactiv√© car d√©pend de Leaflet Routing Machine -->
        
        <!-- Donnees -->
        <script src="data/Region_3.js"></script>
        <script src="data/Departement_4.js"></script>
        <script src="data/Arrondissement_5.js"></script>
        <script src="data/Routes_6.js"></script>
        <script src="data/Localites_7.js"></script>
        <script src="data/Ecoles_8.js"></script>

    <!-- Conteneur isol√© pour le FAB -->
    <div id="fabContainer" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; pointer-events: none !important; z-index: 9999 !important;">
    </div>
    
    <!-- Bouton d'action rapide flottant (FAB) -->
        <div id="fabButton" class="fab-button fab-element" onclick="toggleFabMenu()" style="position: fixed !important; bottom: 25px !important; right: 25px !important; width: 60px !important; height: 60px !important; border-radius: 50% !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border: none !important; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 2px 6px rgba(0, 0, 0, 0.1) !important; cursor: pointer !important; display: flex !important; align-items: center !important; justify-content: center !important; pointer-events: auto !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform-origin: center !important; z-index: 1001 !important;">
            <i class="fas fa-bolt fab-icon" style="color: white !important; font-size: 1.4rem !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2) !important; transition: all 0.3s ease !important;"></i>
        </div>
        
        <!-- Menu FAB radial -->
        <div id="fabMenu" class="fab-menu" style="position: absolute !important; bottom: 95px !important; right: 25px !important; opacity: 0 !important; visibility: hidden !important; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important; pointer-events: auto !important; transform-origin: bottom right !important; z-index: 10000 !important;">
            <div class="fab-item" onclick="showSpatialQuery(); closeFabMenu();" style="background: white !important; border-radius: 12px !important; padding: 14px 18px !important; margin-bottom: 10px !important; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08) !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 14px !important; min-width: 160px !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform: translateX(20px) !important; opacity: 0 !important; pointer-events: auto !important;">
                <i class="fas fa-map" style="color: #667eea !important; font-size: 1.1rem !important; width: 20px !important; text-align: center !important; flex-shrink: 0 !important;"></i>
                <span style="color: #333 !important; font-weight: 600 !important; font-size: 0.95rem !important;">Analyser</span>
            </div>
            <div class="fab-item" onclick="enableRoutingMode(); closeFabMenu();" style="background: white !important; border-radius: 12px !important; padding: 14px 18px !important; margin-bottom: 10px !important; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08) !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 14px !important; min-width: 160px !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform: translateX(20px) !important; opacity: 0 !important; pointer-events: auto !important;">
                <i class="fas fa-road" style="color: #667eea !important; font-size: 1.1rem !important; width: 20px !important; text-align: center !important; flex-shrink: 0 !important;"></i>
                <span style="color: #333 !important; font-weight: 600 !important; font-size: 0.95rem !important;">Itin√©raire</span>
            </div>
            <div class="fab-item" onclick="showAttributeQuery(); closeFabMenu();" style="background: white !important; border-radius: 12px !important; padding: 14px 18px !important; margin-bottom: 10px !important; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08) !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 14px !important; min-width: 160px !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform: translateX(20px) !important; opacity: 0 !important; pointer-events: auto !important;">
                <i class="fas fa-search" style="color: #667eea !important; font-size: 1.1rem !important; width: 20px !important; text-align: center !important; flex-shrink: 0 !important;"></i>
                <span style="color: #333 !important; font-weight: 600 !important; font-size: 0.95rem !important;">Rechercher</span>
            </div>
            <div class="fab-item" onclick="toggleMeasure(); closeFabMenu();" style="background: white !important; border-radius: 12px !important; padding: 14px 18px !important; margin-bottom: 10px !important; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08) !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 14px !important; min-width: 160px !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform: translateX(20px) !important; opacity: 0 !important; pointer-events: auto !important;">
                <i class="fas fa-ruler-combined" style="color: #667eea !important; font-size: 1.1rem !important; width: 20px !important; text-align: center !important; flex-shrink: 0 !important;"></i>
                <span style="color: #333 !important; font-weight: 600 !important; font-size: 0.95rem !important;">Mesurer</span>
            </div>
            <div class="fab-item" onclick="showMiniTutorial(); closeFabMenu();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-radius: 12px !important; padding: 14px 18px !important; margin-bottom: 10px !important; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3), 0 2px 8px rgba(102, 126, 234, 0.2) !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 14px !important; min-width: 160px !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; transform: translateX(20px) !important; opacity: 0 !important; pointer-events: auto !important;">
                <i class="fas fa-graduation-cap" style="color: white !important; font-size: 1.1rem !important; width: 20px !important; text-align: center !important; flex-shrink: 0 !important;"></i>
                <span style="color: white !important; font-weight: 600 !important; font-size: 0.95rem !important;">Tutoriel</span>
            </div>
        </div>
    </div>

        <!-- Application principale -->
        <script src="js/app-modern.js"></script>

        <!-- Script FAB simple -->
        <script>
            function toggleFabMenu() {
                const fabMenu = document.getElementById('fabMenu');
                const fabButton = document.getElementById('fabButton');
                
                if (!fabMenu || !fabButton) return;
                
                if (fabMenu.classList.contains('active')) {
                    fabMenu.classList.remove('active');
                    fabMenu.style.opacity = '0';
                    fabMenu.style.visibility = 'hidden';
                    fabButton.innerHTML = '<i class="fas fa-bolt" style="color: white !important; font-size: 1.4rem !important;"></i>';
                } else {
                    fabMenu.classList.add('active');
                    fabMenu.style.opacity = '1';
                    fabMenu.style.visibility = 'visible';
                    fabMenu.style.zIndex = '10000';
                    fabButton.innerHTML = '<i class="fas fa-times" style="color: white !important; font-size: 1.4rem !important;"></i>';
                    
                    const items = fabMenu.querySelectorAll('.fab-item');
                    items.forEach((item, index) => {
                        setTimeout(() => {
                            item.style.transform = 'translateX(0)';
                            item.style.opacity = '1';
                        }, index * 50);
                    });
                }
            }
            
            function closeFabMenu() {
                const fabMenu = document.getElementById('fabMenu');
                const fabButton = document.getElementById('fabButton');
                
                if (!fabMenu || !fabButton) return;
                
                fabMenu.classList.remove('active');
                
                const items = fabMenu.querySelectorAll('.fab-item');
                items.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.transform = 'translateX(20px)';
                        item.style.opacity = '0';
                    }, index * 30);
                });
                
                setTimeout(() => {
                    fabMenu.style.opacity = '0';
                    fabMenu.style.visibility = 'hidden';
                }, items.length * 30 + 100);
                
                fabButton.innerHTML = '<i class="fas fa-bolt" style="color: white !important; font-size: 1.4rem !important;"></i>';
            }
        </script>

        <!-- Script pour afficher le FAB apr√®s chargement -->
        <script>
            // Attendre que tout soit charg√© avant d'afficher le FAB
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const fabButton = document.getElementById('fabButton');
                    if (fabButton) {
                        fabButton.style.display = 'flex';
                        console.log('[FAB] Bouton d\'action rapide affich√©');
                    }
                }, 1000); // Attendre 1 seconde
            });
        </script>

<!-- Service Worker Registration -->
<!-- D√©sactivation agressive du Service Worker -->
<script>
    // D√©sactiver compl√®tement le Service Worker existant
    if ('serviceWorker' in navigator) {
        // D√©sactiver tous les Service Workers existants
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                console.log('[PWA] D√©sactivation forc√©e du Service Worker:', registration.scope);
                registration.unregister().then(function(success) {
                    if (success) {
                        console.log('[PWA] Service Worker d√©sactiv√© avec succ√®s');
                    }
                });
            }
        });
        
        // Emp√™cher l'enregistrement de nouveaux Service Workers
        navigator.serviceWorker.register = function() {
            console.log('[PWA] Tentative d\'enregistrement de Service Worker bloqu√©e');
            return Promise.reject(new Error('Service Worker d√©sactiv√© pour stabilisation'));
        };
    }
</script>
