<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Couches - G√©oWeb Kaffrine</title>
    
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/app-modern.css?v=21">
    <link rel="stylesheet" href="css/fullscreen-responsive.css?v=21">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        .test-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar-left {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .layer-section {
            margin-bottom: 20px;
        }
        
        .layer-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .layer-item {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .layer-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .layer-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .layer-item-with-opacity {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .layer-header {
            margin-bottom: 8px;
        }
        
        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .opacity-slider {
            flex: 1;
        }
        
        .opacity-value {
            font-size: 0.9rem;
            color: #666;
            min-width: 40px;
        }
        
        .test-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Panneau de gauche -->
        <div class="sidebar-left">
            <div class="panel-header">
                <h3><i class="fas fa-th"></i> Couches</h3>
            </div>
            <div class="panel-content" id="layerControlContainer">
                <!-- Le contr√¥le des couches sera inject√© ici -->
            </div>
        </div>
        
        <!-- Carte -->
        <div class="map-container">
            <div id="map"></div>
            <div class="status" id="status">
                <strong>üß™ Test Couches</strong><br>
                En attente de chargement...
            </div>
            <div class="test-info">
                <strong>üìã Test du panneau des couches</strong><br>
                V√©rifie que les couches s'affichent correctement
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    
    <!-- Donn√©es de test simplifi√©es -->
    <script>
        // Variables globales pour le test
        let map = null;
        let layers = {};
        let clusters = {};
        let layerControl = null;
        
        // Donn√©es GeoJSON simplifi√©es pour le test
        const testData = {
            Region: {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "properties": {"name": "R√©gion Test"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-15.5, 14.0], [-15.0, 14.0], [-15.0, 14.5], [-15.5, 14.5], [-15.5, 14.0]]]
                    }
                }]
            },
            Departement: {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "properties": {"name": "D√©partement Test"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-15.4, 14.1], [-15.2, 14.1], [-15.2, 14.3], [-15.4, 14.3], [-15.4, 14.1]]]
                    }
                }]
            }
        };
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<strong>üß™ Test Couches</strong><br>${message}`;
            status.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : 'white';
            status.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#333';
        }
        
        function initMap() {
            updateStatus('Initialisation de la carte...');
            
            // Cr√©er la carte
            map = L.map('map').setView([14.25, -15.25], 8);
            
            // Fond de carte OpenStreetMap
            layers.OSMStandard = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });
            
            map.addLayer(layers.OSMStandard);
            
            updateStatus('Carte initialis√©e - Chargement des couches...', 'success');
        }
        
        function initDataLayers() {
            updateStatus('Chargement des couches de donn√©es...');
            
            // Couche Region
            if (testData.Region) {
                layers.Region = L.geoJson(testData.Region, {
                    style: {
                        color: '#333',
                        weight: 3,
                        fillOpacity: 0.1
                    }
                }).addTo(map);
            }
            
            // Couche Departement
            if (testData.Departement) {
                layers.Departement = L.geoJson(testData.Departement, {
                    style: {
                        color: '#667eea',
                        weight: 2,
                        fillOpacity: 0.2
                    }
                }).addTo(map);
            }
            
            updateStatus('Couches charg√©es - Initialisation du contr√¥le...', 'success');
        }
        
        function initLayerControl() {
            updateStatus('Cr√©ation du contr√¥le des couches...');
            
            let overlaysTree = [
                {label: '<i class="fas fa-draw-polygon" style="color: #333;"></i> Region', layer: layers.Region},
                {label: '<i class="fas fa-draw-polygon" style="color: #667eea;"></i> Departement', layer: layers.Departement}
            ];
            
            let baseTree = [
                {label: 'OpenStreetMap', layer: layers.OSMStandard, radioGroup: 'bm'}
            ];
            
            // Ajouter le contr√¥le personnalis√© au panneau de gauche
            let layerControlContainer = document.getElementById('layerControlContainer');
            if (layerControlContainer) {
                createCustomLayerControl(layerControlContainer, baseTree, overlaysTree);
                updateStatus('‚úÖ Contr√¥le des couches cr√©√© avec succ√®s!', 'success');
            } else {
                updateStatus('‚ùå Conteneur de contr√¥le non trouv√©', 'error');
            }
        }
        
        function createCustomLayerControl(container, baseTree, overlaysTree) {
            // Vider le conteneur
            container.innerHTML = '';
            
            // Fonds de carte
            let baseSection = document.createElement('div');
            baseSection.className = 'layer-section';
            baseSection.innerHTML = '<h4>Fonds de carte</h4>';
            
            baseTree.forEach(function(item) {
                let div = document.createElement('div');
                div.className = 'layer-item';
                div.innerHTML = `
                    <label>
                        <input type="radio" name="basemap" value="${item.label}" 
                               ${item.layer === layers.OSMStandard ? 'checked' : ''}
                               onchange="changeBasemapByName('${item.label}')">
                        ${item.label}
                    </label>
                `;
                baseSection.appendChild(div);
            });
            
            container.appendChild(baseSection);
            
            // Couches de superposition
            let overlaySection = document.createElement('div');
            overlaySection.className = 'layer-section';
            overlaySection.innerHTML = '<h4>Couches th√©matiques</h4>';
            
            overlaysTree.forEach(function(item) {
                let div = document.createElement('div');
                div.className = 'layer-item-with-opacity';
                let layerName = item.label.replace(/<[^>]*>/g, '').trim();
                div.innerHTML = `
                    <div class="layer-header">
                        <label>
                            <input type="checkbox" checked onchange="toggleLayer('${layerName}', this.checked)">
                            ${item.label}
                        </label>
                    </div>
                    <div class="opacity-control">
                        <span class="opacity-label"><i class="fas fa-eye"></i></span>
                        <input type="range" min="0" max="100" value="100" 
                               class="opacity-slider" 
                               oninput="changeLayerOpacity('${layerName}', this.value)"
                               title="Transparence: 0% (transparent) √† 100% (opaque)">
                        <span class="opacity-value">100%</span>
                    </div>
                `;
                overlaySection.appendChild(div);
            });
            
            container.appendChild(overlaySection);
        }
        
        function changeBasemapByName(name) {
            // Pour le test, on ne fait rien de sp√©cial
            console.log('Basemap chang√©:', name);
        }
        
        function toggleLayer(layerName, visible) {
            let layer = layers[layerName];
            if (layer) {
                if (visible) {
                    map.addLayer(layer);
                    console.log('Couche activ√©e:', layerName);
                } else {
                    map.removeLayer(layer);
                    console.log('Couche d√©sactiv√©e:', layerName);
                }
            }
        }
        
        function changeLayerOpacity(layerName, opacityValue) {
            let layer = layers[layerName];
            if (layer) {
                layer.setOpacity(opacityValue / 100);
                // Mettre √† jour l'affichage
                event.target.nextElementSibling.textContent = opacityValue + '%';
            }
        }
        
        // Initialisation au chargement
        window.addEventListener('load', function() {
            setTimeout(() => {
                initMap();
                setTimeout(() => {
                    initDataLayers();
                    setTimeout(() => {
                        initLayerControl();
                    }, 500);
                }, 500);
            }, 100);
        });
    </script>
</body>
</html>
